"""
í…”ë ˆê·¸ë¨ ì‘ë‹µ ì „ì†¡ê¸° (Sender)

ì—­í• :
- Claude Code ì‘ì—… ê²°ê³¼ë¥¼ í…”ë ˆê·¸ë¨ìœ¼ë¡œ ì „ì†¡
- í…ìŠ¤íŠ¸ ë©”ì‹œì§€ ë° íŒŒì¼ ì²¨ë¶€ ì§€ì›
- ë§ˆí¬ë‹¤ìš´ í¬ë§· ì§€ì›

ì‚¬ìš©ë²•:
    from telegram_sender import send_message, send_files

    # í…ìŠ¤íŠ¸ ë©”ì‹œì§€ ì „ì†¡
    await send_message(chat_id, "ë©”ì‹œì§€ ë‚´ìš©")

    # íŒŒì¼ê³¼ í•¨ê»˜ ì „ì†¡
    await send_files(chat_id, "ë©”ì‹œì§€ ë‚´ìš©", ["íŒŒì¼1.txt", "íŒŒì¼2.png"])
"""

import os
from dotenv import load_dotenv
from telegram import Bot
import asyncio

# .env íŒŒì¼ ë¡œë“œ
load_dotenv()

BOT_TOKEN = os.getenv("TELEGRAM_BOT_TOKEN")


async def send_message(chat_id, text, parse_mode="Markdown"):
    """
    í…”ë ˆê·¸ë¨ ë©”ì‹œì§€ ì „ì†¡

    Args:
        chat_id: ì±„íŒ… ID (ì‚¬ìš©ì ID)
        text: ì „ì†¡í•  ë©”ì‹œì§€
        parse_mode: íŒŒì‹± ëª¨ë“œ (Markdown, HTML, None)

    Returns:
        bool: ì„±ê³µ ì—¬ë¶€
    """
    if not BOT_TOKEN or BOT_TOKEN in ("your_bot_token_here", "YOUR_BOT_TOKEN"):
        print("âŒ TELEGRAM_BOT_TOKEN ë¯¸ì„¤ì •.")
        print("   ë¨¼ì € 'python telegram_listener.py'ë¥¼ ì‹¤í–‰í•˜ì—¬ í† í°ì„ ì„¤ì •í•´ì£¼ì„¸ìš”.")
        return False

    try:
        bot = Bot(token=BOT_TOKEN)

        # í…”ë ˆê·¸ë¨ ë©”ì‹œì§€ ê¸¸ì´ ì œí•œ (4096ì)
        if len(text) > 4000:
            # ê¸´ ë©”ì‹œì§€ëŠ” ë¶„í•  ì „ì†¡
            chunks = [text[i:i+4000] for i in range(0, len(text), 4000)]
            for i, chunk in enumerate(chunks):
                if i > 0:
                    await asyncio.sleep(0.5)  # ì—°ì† ì „ì†¡ ì‹œ ì ì‹œ ëŒ€ê¸°
                await bot.send_message(
                    chat_id=chat_id,
                    text=chunk,
                    parse_mode=parse_mode
                )
        else:
            await bot.send_message(
                chat_id=chat_id,
                text=text,
                parse_mode=parse_mode
            )

        return True

    except Exception as e:
        print(f"âŒ ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨: {e}")
        return False


async def send_file(chat_id, file_path, caption=None):
    """
    í…”ë ˆê·¸ë¨ íŒŒì¼ ì „ì†¡

    Args:
        chat_id: ì±„íŒ… ID
        file_path: íŒŒì¼ ê²½ë¡œ
        caption: íŒŒì¼ ì„¤ëª… (ì„ íƒ)

    Returns:
        bool: ì„±ê³µ ì—¬ë¶€
    """
    if not BOT_TOKEN or BOT_TOKEN in ("your_bot_token_here", "YOUR_BOT_TOKEN"):
        print("âŒ TELEGRAM_BOT_TOKEN ë¯¸ì„¤ì •.")
        print("   ë¨¼ì € 'python telegram_listener.py'ë¥¼ ì‹¤í–‰í•˜ì—¬ í† í°ì„ ì„¤ì •í•´ì£¼ì„¸ìš”.")
        return False

    if not os.path.exists(file_path):
        print(f"âŒ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: {file_path}")
        return False

    try:
        bot = Bot(token=BOT_TOKEN)

        # íŒŒì¼ í¬ê¸° í™•ì¸ (í…”ë ˆê·¸ë¨ ì œí•œ: 50MB)
        file_size = os.path.getsize(file_path)
        if file_size > 50 * 1024 * 1024:
            print(f"âš ï¸  íŒŒì¼ì´ ë„ˆë¬´ í½ë‹ˆë‹¤ ({file_size / 1024 / 1024:.1f}MB). 50MB ì´í•˜ë§Œ ì „ì†¡ ê°€ëŠ¥í•©ë‹ˆë‹¤.")
            return False

        with open(file_path, "rb") as f:
            await bot.send_document(
                chat_id=chat_id,
                document=f,
                caption=caption,
                filename=os.path.basename(file_path)
            )

        return True

    except Exception as e:
        print(f"âŒ íŒŒì¼ ì „ì†¡ ì‹¤íŒ¨: {e}")
        return False


async def send_files(chat_id, text, file_paths):
    """
    í…”ë ˆê·¸ë¨ ë©”ì‹œì§€ + ì—¬ëŸ¬ íŒŒì¼ ì „ì†¡

    Args:
        chat_id: ì±„íŒ… ID
        text: ë©”ì‹œì§€ ë‚´ìš©
        file_paths: íŒŒì¼ ê²½ë¡œ ë¦¬ìŠ¤íŠ¸

    Returns:
        bool: ì„±ê³µ ì—¬ë¶€
    """
    # ë¨¼ì € ë©”ì‹œì§€ ì „ì†¡
    success = await send_message(chat_id, text)

    if not success:
        return False

    # íŒŒì¼ì´ ì—†ìœ¼ë©´ ì¢…ë£Œ
    if not file_paths:
        return True

    # íŒŒì¼ë“¤ ì „ì†¡
    for i, file_path in enumerate(file_paths):
        if i > 0:
            await asyncio.sleep(0.5)  # ì—°ì† ì „ì†¡ ì‹œ ì ì‹œ ëŒ€ê¸°

        file_name = os.path.basename(file_path)
        print(f"ğŸ“ íŒŒì¼ ì „ì†¡ ì¤‘: {file_name}")

        success = await send_file(chat_id, file_path, caption=f"ğŸ“ {file_name}")

        if success:
            print(f"âœ… íŒŒì¼ ì „ì†¡ ì™„ë£Œ: {file_name}")
        else:
            print(f"âŒ íŒŒì¼ ì „ì†¡ ì‹¤íŒ¨: {file_name}")

    return True


def run_async_safe(coro):
    """ì´ë²¤íŠ¸ ë£¨í”„ê°€ ì´ë¯¸ ì‹¤í–‰ ì¤‘ì´ë©´ ë³„ë„ ìŠ¤ë ˆë“œì—ì„œ ì‹¤í–‰"""
    try:
        asyncio.get_running_loop()
        # ë£¨í”„ê°€ ì‹¤í–‰ ì¤‘ â†’ ë³„ë„ ìŠ¤ë ˆë“œì—ì„œ ìƒˆ ë£¨í”„ ìƒì„±
        from concurrent.futures import ThreadPoolExecutor
        with ThreadPoolExecutor(max_workers=1) as pool:
            return pool.submit(asyncio.run, coro).result()
    except RuntimeError:
        # ì‹¤í–‰ ì¤‘ì¸ ë£¨í”„ ì—†ìŒ â†’ ì§ì ‘ ì‹¤í–‰
        return asyncio.run(coro)


# ë™ê¸° í•¨ìˆ˜ ë˜í¼
def send_message_sync(chat_id, text, parse_mode="Markdown"):
    """
    ë™ê¸° ë°©ì‹ ë©”ì‹œì§€ ì „ì†¡

    ë©”ì‹œì§€ ì „ì†¡ ì‹œë§ˆë‹¤:
    1. working.jsonì˜ last_activity ê°±ì‹ 
    2. ìƒˆ ë©”ì‹œì§€ í™•ì¸ ë° ì €ì¥ (ì‘ì—… ì¤‘ì¼ ë•Œë§Œ)
    """
    result = run_async_safe(send_message(chat_id, text, parse_mode))

    # ë©”ì‹œì§€ ì „ì†¡ ì„±ê³µ ì‹œ
    if result:
        try:
            from telegram_bot import (
                update_working_activity,
                check_new_messages_during_work,
                save_new_instructions
            )

            # 1. í™œë™ ì‹œê° ê°±ì‹ 
            update_working_activity()

            # 2. ğŸ†• ìƒˆ ë©”ì‹œì§€ í™•ì¸
            new_msgs = check_new_messages_during_work()
            if new_msgs:
                # íŒŒì¼ì— ì €ì¥
                save_new_instructions(new_msgs)

                # ì•Œë¦¼ ì „ì†¡
                alert_text = f"âœ… **ìƒˆë¡œìš´ ìš”ì²­ {len(new_msgs)}ê°œ í™•ì¸**\n\n"
                for i, msg in enumerate(new_msgs, 1):
                    alert_text += f"{i}. {msg['instruction'][:50]}...\n"
                alert_text += "\nì§„í–‰ ì¤‘ì¸ ì‘ì—…ì— ë°˜ì˜í•˜ê² ìŠµë‹ˆë‹¤."

                # ì¬ê·€ í˜¸ì¶œ ë°©ì§€ (ì•Œë¦¼ì€ í™œë™ ê°±ì‹ ë§Œ í•˜ê³  ìƒˆ ë©”ì‹œì§€ í™•ì¸ ì•ˆ í•¨)
                run_async_safe(send_message(chat_id, alert_text, parse_mode))

        except Exception as e:
            # ê°±ì‹  ì‹¤íŒ¨í•´ë„ ë©”ì‹œì§€ ì „ì†¡ ê²°ê³¼ì—ëŠ” ì˜í–¥ ì—†ìŒ
            pass

    return result


def send_files_sync(chat_id, text, file_paths):
    """ë™ê¸° ë°©ì‹ íŒŒì¼ ì „ì†¡"""
    return run_async_safe(send_files(chat_id, text, file_paths))


if __name__ == "__main__":
    # í…ŒìŠ¤íŠ¸
    import sys

    if len(sys.argv) < 3:
        print("ì‚¬ìš©ë²•: python telegram_sender.py <chat_id> <message>")
        print("ì˜ˆ: python telegram_sender.py 8564459294 'í…ŒìŠ¤íŠ¸ ë©”ì‹œì§€'")
        sys.exit(1)

    chat_id = int(sys.argv[1])
    message = sys.argv[2]

    print(f"ë©”ì‹œì§€ ì „ì†¡ ì¤‘: {chat_id}")
    success = send_message_sync(chat_id, message)

    if success:
        print("âœ… ì „ì†¡ ì„±ê³µ!")
    else:
        print("âŒ ì „ì†¡ ì‹¤íŒ¨!")
