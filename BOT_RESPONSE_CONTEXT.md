# 봇 응답 포함 컨텍스트 가이드

**구현 완료일**: 2026-02-07
**상태**: ✅ 완전 구현

---

## 📌 개요

텔레그램 봇이 이제 **사용자 메시지 + 봇 응답을 모두 포함한 완전한 대화 컨텍스트**를 Claude Code에게 전달합니다!

### 이전 vs 현재

| 항목 | 이전 | 현재 |
|------|------|------|
| 컨텍스트 | 사용자 메시지만 | 사용자 메시지 + 봇 응답 |
| 대화 흐름 이해 | ❌ 불가능 | ✅ 가능 |
| 대명사 참조 | ❌ "거기"가 뭔지 모름 | ✅ "거기" = cafe.html |
| 중복 작업 방지 | ❌ 어려움 | ✅ 이미 한 작업 인식 |

---

## 🎯 해결하는 문제

### 문제 상황 (이전)

```
사용자: 카페 홈페이지 만들어줘
봇: ✅ cafe.html 생성했습니다.

사용자: 거기에 다크모드 추가해줘
Claude: ❓ "거기"가 뭐지? 어떤 파일?
        → 컨텍스트에 봇 응답이 없어서 모름!
```

### 해결 (현재)

```
사용자: 카페 홈페이지 만들어줘
봇: ✅ cafe.html 생성했습니다.

사용자: 거기에 다크모드 추가해줘
Claude: ✅ 컨텍스트 확인!
        "봇: cafe.html 생성했습니다."
        → "거기" = cafe.html!
        → cafe.html에 다크모드 추가 진행
```

---

## 🔧 구현 내용

### 1. telegram_messages.json 구조 확장

**기존**:
```json
{
  "messages": [
    {
      "message_id": 123,
      "text": "카페 홈페이지 만들어줘",
      "timestamp": "2026-02-07 13:00:00",
      "processed": false
    }
  ]
}
```

**현재**:
```json
{
  "messages": [
    {
      "message_id": 123,
      "type": "user",  // 🆕 메시지 타입
      "text": "카페 홈페이지 만들어줘",
      "timestamp": "2026-02-07 13:00:00",
      "processed": true
    },
    {
      "message_id": "bot_123",  // 🆕 봇 응답
      "type": "bot",
      "text": "✅ 완료! cafe.html을 생성했습니다.",
      "files": ["cafe.html", "styles.css"],
      "timestamp": "2026-02-07 13:05:00",
      "reply_to": [123],  // 어떤 메시지에 대한 응답인지
      "processed": true
    }
  ]
}
```

### 2. 봇 응답 저장 함수

**telegram_bot.py**:
```python
def save_bot_response(chat_id, text, reply_to_message_ids, files=None):
    """
    봇 응답을 telegram_messages.json에 저장 (대화 컨텍스트 유지)

    Args:
        chat_id: 채팅 ID
        text: 봇 응답 메시지
        reply_to_message_ids: 응답 대상 메시지 ID (리스트)
        files: 전송한 파일 리스트 (선택)
    """
    # telegram_messages.json에 봇 응답 추가
```

**호출 위치**: `report_telegram()` 함수 - 텔레그램 전송 성공 후

### 3. 컨텍스트 생성 개선

**get_24h_context() 함수**:
```python
def get_24h_context(messages, current_message_id):
    """
    최근 24시간 대화 내역 생성 (사용자 + 봇 응답 모두 포함)
    """
    # 사용자 메시지
    if msg_type == "user":
        context_lines.append(f"[{timestamp}] {user_name}: {text}")

    # 봇 응답
    elif msg_type == "bot":
        context_lines.append(f"[{timestamp}] 🤖 소놀봇: {text}")
```

---

## 📝 컨텍스트 예시

### 실제 대화

```
[2026-02-07 13:00:00] 홍길동: 카페 홈페이지 만들어줘
[2026-02-07 13:05:00] 🤖 소놀봇: ✅ 완료! cafe.html을 생성했습니다.
                                반응형 디자인으로 제작했습니다.
                                [전송: cafe.html, styles.css]

[2026-02-07 14:00:00] 홍길동: 거기에 다크모드도 추가해줘
[2026-02-07 14:05:00] 🤖 소놀봇: ✅ 다크모드 추가 완료!
                                CSS에 다크모드 스타일을 추가했습니다.
                                [전송: cafe.html, styles.css]

[2026-02-07 15:00:00] 홍길동: 로고도 추가해줘 [첨부: 1개 파일]
```

### Claude Code가 받는 컨텍스트

```
=== 최근 24시간 대화 내역 ===

[2026-02-07 13:00:00] 홍길동: 카페 홈페이지 만들어줘
[2026-02-07 13:05:00] 🤖 소놀봇: ✅ 완료! cafe.html을 생성했습니다.
                                반응형 디자인으로 제작했습니다.
                                [전송: cafe.html, styles.css]

[2026-02-07 14:00:00] 홍길동: 거기에 다크모드도 추가해줘
[2026-02-07 14:05:00] 🤖 소놀봇: ✅ 다크모드 추가 완료!
                                CSS에 다크모드 스타일을 추가했습니다.
                                [전송: cafe.html, styles.css]
```

---

## 💡 활용 사례

### 1. 대명사 참조 이해

```
사용자: 카페 사이트 만들어줘
봇: ✅ cafe.html 완성!

사용자: 거기에 메뉴 페이지 추가해줘
Claude: ✅ "거기" = cafe.html (컨텍스트에서 확인)
```

### 2. 중복 작업 방지

```
사용자: 다크모드 추가해줘
봇: ✅ 다크모드 추가 완료!

사용자: 다크모드도 넣어줘
Claude: ✅ 이미 다크모드가 추가되었습니다. (컨텍스트 확인)
        새로운 작업 없이 완료 메시지만 전송
```

### 3. 연속된 요청 처리

```
사용자: 이력서 만들어줘
봇: ✅ resume.pdf 생성!

사용자: 거기에 사진 추가해줘 [이미지 첨부]
봇: ✅ 사진 추가 완료!

사용자: 폰트도 좀 더 깔끔하게
Claude: ✅ resume.pdf의 폰트 변경
        (어떤 파일을 수정해야 하는지 컨텍스트에서 확인)
```

### 4. 파일 추적

```
사용자: 명함 디자인해줘
봇: ✅ business_card.html 생성! [전송: business_card.html, card.css]

사용자: 방금 만든 파일 PDF로 변환해줘
Claude: ✅ "방금 만든 파일" = business_card.html (컨텍스트 확인)
        → PDF 변환 진행
```

---

## 🧪 테스트

### 테스트 파일
```bash
python test_bot_response_context.py
```

### 테스트 결과
```
============================================================
봇 응답 포함 컨텍스트 테스트
============================================================

3. 컨텍스트 검증:

   ✅ 사용자 메시지: 2개 포함
   ✅ 봇 응답: 2개 포함
   ✅ 전송 파일 정보 포함

4. 대화 흐름 이해도 테스트:

   ✅ Claude Code가 '거기'가 cafe.html임을 알 수 있습니다!
   ✅ Claude Code가 이미 다크모드가 추가되었음을 알 수 있습니다!
   ✅ 대화 흐름 이해 가능! ✨

============================================================
✅ 테스트 완료!
============================================================
```

---

## 📊 메시지 타입

| 타입 | 설명 | message_id 형식 | 저장 시점 |
|------|------|-----------------|----------|
| **user** | 사용자 메시지 | 텔레그램 message_id | telegram_listener.py |
| **bot** | 봇 응답 | "bot_{원본_message_id}" | report_telegram() |

---

## 🔍 하위 호환성

기존 메시지(type 필드 없음)는 자동으로 "user"로 간주됩니다:

```python
msg_type = msg.get("type", "user")  # 기본값 user
```

---

## 📈 성능

- **저장 오버헤드**: 거의 없음 (JSON 파일 append)
- **컨텍스트 크기**: 봇 응답은 150자 이상 시 자동 요약
- **메모리**: telegram_messages.json 크기 증가 (30일 자동 정리)

---

## 🎯 다음 단계

1. ⬜ 봇 응답 요약 개선 (긴 응답 자동 요약)
2. ⬜ 이미지 OCR 결과도 컨텍스트에 포함
3. ⬜ 음성 메시지 STT 결과도 컨텍스트에 포함
4. ⬜ 대화 요약 기능 (1주일치 대화 → 요약)

---

**문의**: CLAUDE.md 참조
**테스트 파일**: `test_bot_response_context.py`
**관련 문서**: `FILE_SUPPORT.md` (이미지/파일 지원)
